<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>javascripts/dashboard/LineChart.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/knoxjeffrey/personal_website" target="_blank" class="menu-item" id="repository" >Github repo</a></h2><h3>Classes</h3><ul><li><a href="CommentsController.html">CommentsController</a><ul class='members'><li data-type='member' style='display: none;'><a href="CommentsController.html#.targets">targets</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="CommentsController.html#load">load</a></li></ul></li><li><a href="Game.EPController.html">Game.EPController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Game.EPController.html#initialize">initialize</a></li></ul></li><li><a href="Game.HIPSController.html">Game.HIPSController</a><ul class='members'><li data-type='member' style='display: none;'><a href="Game.HIPSController.html#.targets">targets</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="Game.HIPSController.html#submit">submit</a></li></ul></li><li><a href="Game.LTBLController.html">Game.LTBLController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Game.LTBLController.html#next">next</a></li></ul></li><li><a href="Game.MOTController.html">Game.MOTController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Game.MOTController.html#connect">connect</a></li></ul></li><li><a href="Game.MYMController.html">Game.MYMController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Game.MYMController.html#connect">connect</a></li></ul></li><li><a href="Game.RDController.html">Game.RDController</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Game.RDController.html#connect">connect</a></li></ul></li><li><a href="javascripts.dashboard.LineChart.html">javascripts.dashboard.LineChart</a><ul class='methods'><li data-type='method' style='display: none;'><a href="javascripts.dashboard.LineChart.html#closestDataPoint">closestDataPoint</a></li><li data-type='method' style='display: none;'><a href="javascripts.dashboard.LineChart.html#createDataVis">createDataVis</a></li><li data-type='method' style='display: none;'><a href="javascripts.dashboard.LineChart.html#initialiseAccessors">initialiseAccessors</a></li><li data-type='method' style='display: none;'><a href="javascripts.dashboard.LineChart.html#initialiseDataVis">initialiseDataVis</a></li><li data-type='method' style='display: none;'><a href="javascripts.dashboard.LineChart.html#kpiLineTransition">kpiLineTransition</a></li><li data-type='method' style='display: none;'><a href="javascripts.dashboard.LineChart.html#setGenerators">setGenerators</a></li><li data-type='method' style='display: none;'><a href="javascripts.dashboard.LineChart.html#setScales">setScales</a></li><li data-type='method' style='display: none;'><a href="javascripts.dashboard.LineChart.html#tweenDashIn">tweenDashIn</a></li><li data-type='method' style='display: none;'><a href="javascripts.dashboard.LineChart.html#updateDataVis">updateDataVis</a></li></ul></li><li><a href="RUMController.html">RUMController</a><ul class='members'><li data-type='member' style='display: none;'><a href="RUMController.html#.classes">classes</a></li><li data-type='member' style='display: none;'><a href="RUMController.html#.rumIdentifier">rumIdentifier</a></li><li data-type='member' style='display: none;'><a href="RUMController.html#.targets">targets</a></li><li data-type='member' style='display: none;'><a href="RUMController.html#.values">values</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="RUMController.html#alertColor">alertColor</a></li><li data-type='method' style='display: none;'><a href="RUMController.html#alertSubstring">alertSubstring</a></li><li data-type='method' style='display: none;'><a href="RUMController.html#clsValueChanged">clsValueChanged</a></li><li data-type='method' style='display: none;'><a href="RUMController.html#coreWebVitalResponse">coreWebVitalResponse</a></li><li data-type='method' style='display: none;'><a href="RUMController.html#disconnect">disconnect</a></li><li data-type='method' style='display: none;'><a href="RUMController.html#fidValueChanged">fidValueChanged</a></li><li data-type='method' style='display: none;'><a href="RUMController.html#initialize">initialize</a></li><li data-type='method' style='display: none;'><a href="RUMController.html#lcpValueChanged">lcpValueChanged</a></li><li data-type='method' style='display: none;'><a href="RUMController.html#postRumLoggerData">postRumLoggerData</a></li><li data-type='method' style='display: none;'><a href="RUMController.html#reveal">reveal</a></li><li data-type='method' style='display: none;'><a href="RUMController.html#rumLogger">rumLogger</a></li><li data-type='method' style='display: none;'><a href="RUMController.html#visitorIsBot">visitorIsBot</a></li></ul></li></ul><h3>Namespaces</h3><ul><li><a href="javascripts.dashboard.LineChart_modules.html">javascripts.dashboard.LineChart_modules</a></li><li><a href="javascripts.dashboard.utils.html">javascripts.dashboard.utils</a><ul class='methods'><li data-type='method' style='display: none;'><a href="javascripts.dashboard.utils.html#.targetLineValues">targetLineValues</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">javascripts/dashboard/LineChart.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import d3 from "~/javascripts/dashboard/LineChart_modules"
import { targetLineValues } from "~/javascripts/dashboard/utils"

/**
 * @class javascripts.dashboard.LineChart
 * @classdesc d3.js line chart for Netlify build times
 */
export default class LineChart {
  constructor(store, minYValue, wrapper, tooltip) {
    this.store = store
    this.minYValue = minYValue
    this.wrapper = d3.select(wrapper)
    this.tooltip = d3.select(tooltip)
    this.tooltipCircle = null
    this.dv = {
      yAccessor: null,
      xAccessor: null,
      dateAccessor: null,
      deployIdAccessor: null,
      yScale: null,
      xScale: null,
      yAxisGenerator: null,
      xAxisGenerator: null,
      lineGenerator: null,
      bounds: null
    }
    this.dimensions = {
      width: parseInt(this.wrapper.style("width"), 10),
      height: 400,
      margin: {
        top: 15,
        right: 10,
        bottom: 40,
        left: 20,
      }
    }
    this.dimensions.boundedWidth = this.dimensions.width
      - this.dimensions.margin.left
      - this.dimensions.margin.right
    this.dimensions.boundedHeight = this.dimensions.height
      - this.dimensions.margin.top
      - this.dimensions.margin.bottom
  }

  /** 
   * Called the first time the page is loaded to setup the visualisation
   *
   * @instance
   * @memberof javascripts.dashboard.LineChart
   **/
  createDataVis() {
    this.initialiseAccessors()
    this.setScales()
    this.setGenerators()
    this.initialiseDataVis()
    this.kpiLineTransition()
  }

  /** 
   * When the data set is updated this will cause the visualisation to animate
   *
   * @instance
   * @memberof javascripts.dashboard.LineChart
   **/
  updateDataVis() {
    const data = this.store.selectedContextData
    const updatedLine = this.dv.bounds.select("path").data(data)

    this.setScales()
    this.setGenerators()

    updatedLine.attr("d", this.dv.lineGenerator(data))
        .call(this.lineTransitionIn)
    this.dv.bounds.select(".line-chart--y-axis")
        .transition().duration(250)
        .call(this.dv.yAxisGenerator)
    this.dv.bounds.select(".line-chart--x-axis")
        .transition().duration(250)
        .call(this.dv.xAxisGenerator)
    this.kpiLineTransition()
  }

  /** 
   * Setup the accessors for the visualisation
   *
   * @instance
   * @memberof javascripts.dashboard.LineChart
   **/
  initialiseAccessors() {
    this.dv.yAccessor = d => d.deploy_time
    this.dv.xAccessor = d => d.build_number
    this.dv.dateAccessor = d => new Date(d.created_at)
    this.dv.deployIdAccessor = d => d.deploy_id
  }

  /** 
   * Setup the scales for the visualisation which can be updated as the data set changes
   *
   * @instance
   * @memberof javascripts.dashboard.LineChart
   **/
  setScales() {
    this.dv.yScale = d3.scaleLinear()
      .domain([
        0, d3.max([this.minYValue, d3.max(this.store.selectedContextData.map(data => data.deploy_time))])
      ])
      .range([this.dimensions.boundedHeight, 0])
      .nice()
    this.dv.xScale = d3.scaleLinear()
      .domain(d3.extent(this.store.selectedContextData, this.dv.xAccessor))
      .range([0, this.dimensions.boundedWidth])
  }

  /** 
   * Setup the generators for the visualisation which can be updated as the data set changes
   *
   * @instance
   * @memberof javascripts.dashboard.LineChart
   **/
  setGenerators() {
    this.dv.yAxisGenerator = d3.axisLeft()
      .scale(this.dv.yScale)
    this.dv.xAxisGenerator = d3.axisBottom()
      .scale(this.dv.xScale)
      .tickValues(this.store.selectedContextData.map(data => data.build_number))
      .tickFormat(d3.format(".0f"))
    // Duration line generator with animation
    this.dv.lineGenerator = d3.line()
      .x(d => this.dv.xScale(this.dv.xAccessor(d)))
      .y(d => this.dv.yScale(this.dv.yAccessor(d)))
      .curve(d3.curveMonotoneX)
  }

  /** 
   * Setup the structure of the visualisation
   *
   * @instance
   * @memberof javascripts.dashboard.LineChart
   **/
  initialiseDataVis() {
    // Draw canvas
    const wrapperSvg = this.wrapper.append("svg")
      .attr("width", this.dimensions.width)
      .attr("height", this.dimensions.height)

    // Draw the bounds
    this.dv.bounds = wrapperSvg.append("g")
        .style("transform", `translate(${
          this.dimensions.margin.left
        }px, ${
          this.dimensions.margin.top
        }px)`)

    // Setup listener rect for mouse overs
    const listeningRect = this.dv.bounds.append("rect")
        .attr("class", "line-chart--listening-rect")
        .attr("width", this.dimensions.boundedWidth)
        .attr("height", this.dimensions.boundedHeight)
        .on("mousemove", this.onMouseMove)
        .on("mouseleave", this.onMouseLeave)
        .on("click", this.onClick)

    // Setup tooltip when mousing over the listener rect
    this.tooltipCircle = this.dv.bounds.append("circle")
        .attr("class", "line-chart--tooltip-circle")
        .attr("r", 4)

    // Setup build duration line
    const line = this.dv.bounds.append("path")
        .attr("class", "line-chart--path")
        .attr("d", this.dv.lineGenerator(this.store.selectedContextData))
        .call(this.lineTransitionIn)

    // Setup axis
    const yAxis = this.dv.bounds.append("g")
        .attr("class", "line-chart--y-axis")
        .call(this.dv.yAxisGenerator)

    const xAxis = this.dv.bounds.append("g")
        .attr("class", "line-chart--x-axis")
        .call(this.dv.xAxisGenerator)
          .style("transform", `translateY(${
            this.dimensions.boundedHeight
          }px)`)
      .append("text")
        .attr("class", "line-chart--x-axis-label")
        .attr("x", this.dimensions.boundedWidth / 2)
        .attr("y", this.dimensions.margin.bottom - 5)
        .text("Build number")

    // Setup KPI lines to start from zero on y axis. These will animate into position with kpiLineTransition
    const targetKpiLine = this.dv.bounds.append("line")
        .attr("class", "line-chart--success-line")
        .attr("x1", this.dv.xScale(this.dv.xAccessor(this.store.selectedContextData)))
        .attr("x2", this.dimensions.boundedWidth)
        .attr("y1", this.dv.yScale(0))
        .attr("y2", this.dv.yScale(0))

    const lowerBoundtKpiLine = this.dv.bounds.append("line")
        .attr("class", "line-chart--fail-line")
        .attr("x1", this.dv.xScale(this.dv.xAccessor(this.store.selectedContextData)))
        .attr("x2", this.dimensions.boundedWidth)
        .attr("y1", this.dv.yScale(0))
        .attr("y2", this.dv.yScale(0))
  }

  /** 
   * Animate new line drawing in
   *
   * @instance
   * @memberof javascripts.dashboard.LineChart
   **/
  lineTransitionIn = path => {
    path.transition().duration(500)
        .attrTween("stroke-dasharray", this.tweenDashIn)
  }

  /** 
   * Animate new line drawing in
   *
   * @instance
   * @memberof javascripts.dashboard.LineChart
   **/
  tweenDashIn() {
    const length = this.getTotalLength()
    const i = d3.interpolateString(`0, ${length}`, `${length}, ${length}`)
    return function (t) { return i(t) }
  }

  /** 
   * Animate KPI lines
   *
   * @instance
   * @memberof javascripts.dashboard.LineChart
   **/
  kpiLineTransition() {
    const data = this.store.selectedContextData
    const lineValues = targetLineValues(this.store.contextSelected)

    this.dv.bounds.select(".line-chart--success-line")
        .transition().duration(250)
        .attr("x1", this.dv.xScale(this.dv.xAccessor(data)))
        .attr("x2", this.dimensions.boundedWidth)
        .attr("y1", this.dv.yScale(lineValues.successLineValue))
        .attr("y2", this.dv.yScale(lineValues.successLineValue))

    this.dv.bounds.select(".line-chart--fail-line")
        .transition().duration(250)
        .attr("x1", this.dv.xScale(this.dv.xAccessor(data)))
        .attr("x2", this.dimensions.boundedWidth)
        .attr("y1", this.dv.yScale(lineValues.failLineValue))
        .attr("y2", this.dv.yScale(lineValues.failLineValue))
  }

  /** 
   *  Calculate which data point is selected on mouseover
   *
   * @instance
   * @memberof javascripts.dashboard.LineChart
   **/
  onMouseMove = event => {
    const closestDataset = this.closestDataPoint(event)

    const closestXValue = this.dv.xAccessor(closestDataset)
    const closestYValue = this.dv.yAccessor(closestDataset)

    const formatDate = d3.timeFormat("%a %-d %b, %H:%M")
    this.tooltip.select("[data-viz='date']")
        .text(formatDate(this.dv.dateAccessor(closestDataset)))

    this.tooltip.select("[data-viz='duration']")
        .html(`${closestYValue} s`)

    const x = this.dv.xScale(closestXValue) + this.dimensions.margin.left
    const y = this.dv.yScale(closestYValue) + this.dimensions.margin.top

    this.tooltip.style("transform", `translate(`
      + `calc( -50% + ${x}px),`
      + `calc(-100% + ${y}px)`
      + `)`)

    this.tooltip.transition().duration(25)
        .style("opacity", 1)

    this.tooltipCircle.transition().duration(25)
        .attr("cx", this.dv.xScale(closestXValue))
        .attr("cy", this.dv.yScale(closestYValue))
        .style("opacity", 1)
  }

  /** 
   *  Handle mouse leave
   *
   * @instance
   * @memberof javascripts.dashboard.LineChart
   **/
  onMouseLeave = () => {
    this.tooltip.transition().duration(25)
        .style("opacity", 0)
    this.tooltipCircle.transition().duration(25)
        .style("opacity", 0)
  }

  /** 
   *  Open Netlify build logs for selected build
   *
   * @instance
   * @memberof javascripts.dashboard.LineChart
   **/
  onClick = event => {
    const deployId = this.dv.deployIdAccessor(this.closestDataPoint(event))
    // window.open(
    //   `https://app.netlify.com/sites/jeffreyknox/deploys/${deployId}`, '_blank'
    // );
  }

  /** 
   *  Get the closest data point based on mouse position in listening rect
   *
   * @instance
   * @memberof javascripts.dashboard.LineChart
   **/
  closestDataPoint(event) {
    const mousePosition = d3.pointer(event)
    const hoveredDate = this.dv.xScale.invert(mousePosition[0])

    const getDistanceFromHoveredDate = d => Math.abs(this.dv.xAccessor(d) - hoveredDate)
    const closestIndex = d3.leastIndex(this.store.selectedContextData, (a, b) => (
      getDistanceFromHoveredDate(a) - getDistanceFromHoveredDate(b)
    ))
    return this.store.selectedContextData[closestIndex]
  }
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
